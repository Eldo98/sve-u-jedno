<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAoPo3Dj5yoH4sQeTScWZce-jDDpkDPMt8",
        authDomain: "nou-management.firebaseapp.com",
        databaseURL: "https://nou-management-default-rtdb.firebaseio.com",
        projectId: "nou-management",
        storageBucket: "nou-management.firebasestorage.app",
        messagingSenderId: "1098791447574",
        appId: "1:1098791447574:web:6e4c666d302055658c9937",
        measurementId: "G-0MTKC7CZRJ"
    };

    // Inicijalizacija
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Globalne varijable
    const DEFAULT_BG = "https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=1920";
    const DEFAULT_ACCENT = "#00d4ff";
    let userDB = {};
    let session = { user: null };

    // --- SINHRONIZACIJA PODATAKA ---

    // Slušaj korisnike
    onValue(ref(db, 'users'), (snapshot) => {
        userDB = snapshot.val() || { "admin": { pass: "admin123", role: "admin" } };
        renderUserList();
        checkAutoLogin();
    });

    // Slušaj Chat
    onValue(ref(db, 'chat'), (snapshot) => {
        const data = snapshot.val();
        renderChat(data ? Object.values(data) : []);
    });

    // Slušaj Online statuse
    onValue(ref(db, 'online'), (snapshot) => {
        const onlineStatus = snapshot.val() || {};
        const now = Date.now();
        let count = 0;
        
        for (let u in onlineStatus) {
            if (now - onlineStatus[u] < 15000) count++;
        }
        document.getElementById('live-count').innerText = `${count} Online`;
        renderUserList(onlineStatus);
    });

    // --- FUNKCIJE SISTEMA ---

    window.handleLogin = function() {
        const u = document.getElementById('user-in').value;
        const p = document.getElementById('pass-in').value;
        if (userDB[u] && userDB[u].pass === p) {
            session.user = u;
            localStorage.setItem('os_active_session', u);
            bootOS();
            updateStatus(true);
        } else { alert("Pogrešni podaci!"); }
    };

    function checkAutoLogin() {
        const activeUser = localStorage.getItem('os_active_session');
        if (activeUser && userDB[activeUser] && !session.user) {
            session.user = activeUser;
            bootOS();
            updateStatus(true);
        }
    }

    function bootOS() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-os').style.display = 'block';
        document.getElementById('taskbar-user').innerText = session.user;
        
        // Primeni preferencije (mogu se isto dodati u Firebase kasnije)
        document.body.style.backgroundImage = `url('${DEFAULT_BG}')`;
        
        if (userDB[session.user].role === 'admin') {
            document.getElementById('admin-tools').style.display = 'block';
        }
    }

    function updateStatus(isOnline) {
        if (!session.user) return;
        const statusRef = ref(db, 'online/' + session.user);
        if (isOnline) {
            set(statusRef, Date.now());
        } else {
            remove(statusRef);
        }
    }

    // Heartbeat (javi da si online svake 10s)
    setInterval(() => updateStatus(true), 10000);

    window.sendChatMessage = function() {
        const input = document.getElementById('chat-input');
        if(!input.value.trim()) return;
        
        const chatRef = ref(db, 'chat');
        push(chatRef, {
            sender: session.user,
            text: input.value,
            time: Date.now()
        });
        input.value = '';
    };

    function renderChat(history) {
        const box = document.getElementById('chat-messages');
        box.innerHTML = history.map(m => `
            <div class="msg ${m.sender === session.user ? 'msg-me' : 'msg-other'}">
                <b>${m.sender}</b>: ${m.text}
            </div>
        `).join('');
        box.scrollTop = box.scrollHeight;
    }

    function renderUserList(onlineStatus = {}) {
        const table = document.getElementById('user-table');
        if (!table) return;
        let html = '<tr><th>Korisnik</th><th>Status</th></tr>';
        Object.keys(userDB).forEach(u => {
            const isOnline = (Date.now() - (onlineStatus[u] || 0) < 15000);
            html += `<tr><td>${u}</td><td>${isOnline ? '<span style="color:green">● Online</span>' : '<span style="color:gray">Offline</span>'}</td></tr>`;
        });
        table.innerHTML = html;
    }

    window.createNewUser = function() {
        const n = document.getElementById('new-user-name').value;
        const p = document.getElementById('new-user-pass').value;
        if(n && p) {
            update(ref(db, 'users/' + n), { pass: p, role: 'user' });
            alert("Korisnik dodat!");
        }
    };

    window.logout = function() {
        updateStatus(false);
        localStorage.removeItem('os_active_session');
        location.reload();
    };

    // UI interakcije moraju biti window. funkcije zbog type="module"
    window.openApp = (id) => { document.getElementById(id).style.display = 'flex'; };
    window.closeApp = (id) => { document.getElementById(id).style.display = 'none'; };

    // Sat
    setInterval(() => { 
        if(document.getElementById('clock')) 
            document.getElementById('clock').innerText = new Date().toLocaleTimeString(); 
    }, 1000);
</script>
