<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeminiOS v12.0 | Fix Edition</title>
    <style>
        :root { --accent: #00d4ff; --glass: rgba(255, 255, 255, 0.1); --win-bg: #ffffff; --taskbar: rgba(0, 0, 0, 0.95); --os-font: 'Segoe UI', sans-serif; --danger: #e74c3c; --success: #27ae60; }
        * { box-sizing: border-box; font-family: var(--os-font); user-select: none; }
        body { margin: 0; padding: 0; height: 100vh; overflow: hidden; background: #111 url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=1920') no-repeat center center fixed; background-size: cover; }
        
        #login-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(25px); display: flex; justify-content: center; align-items: center; z-index: 999999; }
        .login-box { background: var(--glass); padding: 40px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); text-align: center; color: white; width: 350px; }
        .login-box input { width:100%; padding:12px; margin-bottom:10px; border-radius:8px; border:none; outline:none; background: white; color: black; }
        
        #main-os { display: none; height: 100vh; width: 100vw; }
        #desktop { height: calc(100vh - 45px); padding: 25px; display: flex; flex-direction: column; flex-wrap: wrap; gap: 20px; align-content: flex-start; }
        .icon { width: 95px; text-align: center; color: white; cursor: pointer; transition: 0.2s; }
        .icon span { font-size: 50px; display: block; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.6)); }
        .icon label { font-size: 12px; margin-top: 5px; display: block; text-shadow: 1px 1px 3px #000; }

        .window { position: absolute; background: var(--win-bg); border-radius: 12px; box-shadow: 0 25px 70px rgba(0,0,0,0.7); display: none; flex-direction: column; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); z-index: 10; }
        .window-header { background: #f1f1f1; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; cursor: move; }
        .win-close { width: 14px; height: 14px; border-radius: 50%; background: #ff5f56; cursor: pointer; }

        #chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; background: #fdfdfd; display: flex; flex-direction: column; gap: 10px; height: 300px; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 80%; font-size: 13px; color: #333; }
        .msg-me { background: var(--accent); align-self: flex-end; }
        .msg-other { background: #eee; align-self: flex-start; }

        #taskbar { position: fixed; bottom: 0; width: 100%; height: 45px; background: var(--taskbar); backdrop-filter: blur(20px); display: flex; align-items: center; padding: 0 15px; z-index: 1000000; color: white; }
        #start-btn { width: 34px; height: 34px; background: var(--accent); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; color: black; }
        #clock { margin-left: auto; font-size: 14px; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
        .del-btn { background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <div style="font-size: 60px;">‚ôä</div>
        <h2>NOU OS Login</h2>
        <input type="text" id="user-in" placeholder="Username">
        <input type="password" id="pass-in" placeholder="Password">
        <button id="login-btn" style="width:100%; padding:12px; border-radius:8px; background:var(--accent); font-weight:bold; cursor:pointer; border:none;">ULAZ</button>
        
        <p id="force-admin" style="margin-top: 20px; font-size: 10px; color: var(--accent); cursor: pointer; text-decoration: underline;">
            Klikni ovde ako "admin" ne radi (Popravi bazu)
        </p>
    </div>
</div>

<div id="main-os">
    <div id="desktop">
        <div class="icon" ondblclick="openApp('nou-app')"><span>üè¢</span><label>NOU Hub</label></div>
        <div class="icon" ondblclick="openApp('chat-win')"><span>üí¨</span><label>Chat</label></div>
        <div class="icon" ondblclick="logout()"><span>üö™</span><label>Izlaz</label></div>
    </div>

    <div id="chat-win" class="window" style="width: 350px; height: 450px; left: 400px; top: 100px;">
        <div class="window-header"><span style="font-size:12px; font-weight:bold;">üí¨ Tim Chat</span><div class="win-close" onclick="closeApp('chat-win')"></div></div>
        <div id="chat-messages"></div>
        <div style="padding:10px; display:flex; gap:5px; border-top:1px solid #eee;">
            <input type="text" id="chat-input" placeholder="Poruka..." style="flex:1; padding:5px;">
            <button id="send-btn" style="background:var(--accent); border:none; padding:5px 10px; cursor:pointer;">></button>
        </div>
    </div>

    <div id="nou-app" class="window" style="width: 450px; height: 400px; left: 50px; top: 50px;">
        <div class="window-header"><span style="font-size:12px; font-weight:bold;">üè¢ NOU Management</span><div class="win-close" onclick="closeApp('nou-app')"></div></div>
        <div style="padding:15px; overflow-y:auto;">
            <div id="admin-tools" style="display:none; background:#f0f0f0; padding:10px; border-radius:8px; margin-bottom:10px;">
                <input type="text" id="new-u" placeholder="User" style="width:70px;">
                <input type="text" id="new-p" placeholder="Pass" style="width:70px;">
                <button id="add-user-btn" style="background:var(--success); color:white; border:none; padding:5px; border-radius:4px; cursor:pointer;">Dodaj</button>
            </div>
            <table id="user-table"></table>
        </div>
    </div>

    <div id="taskbar">
        <div id="start-btn">‚ôä</div>
        <div id="taskbar-user" style="margin-left:15px; font-size:12px; font-weight:bold;"></div>
        <div id="live-count" style="margin-left:15px; font-size:10px; background:var(--success); padding:2px 6px; border-radius:10px;">Online: 0</div>
        <div id="clock">00:00:00</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAoPo3Dj5yoH4sQeTScWZce-jDDpkDPMt8",
        authDomain: "nou-management.firebaseapp.com",
        databaseURL: "https://nou-management-default-rtdb.firebaseio.com",
        projectId: "nou-management",
        storageBucket: "nou-management.firebasestorage.app",
        messagingSenderId: "1098791447574",
        appId: "1:1098791447574:web:6e4c666d302055658c9937",
        measurementId: "G-0MTKC7CZRJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let userDB = {};
    let sessionUser = null;
    let onlineData = {};

    // --- SINHRONIZACIJA KORISNIKA ---
    onValue(ref(db, 'users'), (snapshot) => {
        userDB = snapshot.val() || {};
        
        // Auto-login provera
        const saved = localStorage.getItem('os_session');
        if (saved && userDB[saved] && !sessionUser) {
            sessionUser = saved;
            bootOS();
        }
        renderUserList();
    });

    // --- FORCE ADMIN FUNKCIJA (AKO JE BAZA PRAZNA) ---
    document.getElementById('force-admin').onclick = () => {
        set(ref(db, 'users/admin'), { pass: "admin123", role: "admin" })
        .then(() => alert("Admin nalog je uspe≈°no kreiran u bazi! Probaj sad login."))
        .catch(err => alert("Gre≈°ka! Proveri Firebase Rules: " + err.message));
    };

    // --- LOGIN ---
    document.getElementById('login-btn').onclick = () => {
        const u = document.getElementById('user-in').value.trim();
        const p = document.getElementById('pass-in').value.trim();
        
        if (userDB[u] && userDB[u].pass === p) {
            sessionUser = u;
            localStorage.setItem('os_session', u);
            bootOS();
            updateStatus();
        } else {
            alert("Neispravno! Probaj: admin / admin123. Ako ne radi, klikni na plavi tekst ispod.");
        }
    };

    function bootOS() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-os').style.display = 'block';
        document.getElementById('taskbar-user').innerText = sessionUser;
        if (userDB[sessionUser]?.role === 'admin') document.getElementById('admin-tools').style.display = 'block';
        
        // Pokreni online heartbeat
        setInterval(updateStatus, 10000);
        updateStatus();
    }

    // --- ONLINE SISTEM ---
    function updateStatus() {
        if (sessionUser) set(ref(db, 'online/' + sessionUser), Date.now());
    }

    onValue(ref(db, 'online'), (snapshot) => {
        onlineData = snapshot.val() || {};
        let count = 0;
        const now = Date.now();
        for (let u in onlineData) { if (now - onlineData[u] < 25000) count++; }
        document.getElementById('live-count').innerText = "Online: " + count;
        renderUserList();
    });

    // --- CHAT ---
    onValue(ref(db, 'chat'), (snapshot) => {
        const data = snapshot.val() ? Object.values(snapshot.val()) : [];
        const box = document.getElementById('chat-messages');
        box.innerHTML = data.map(m => `
            <div class="msg ${m.sender === sessionUser ? 'msg-me' : 'msg-other'}">
                <b style="font-size:10px; display:block;">${m.sender}</b>${m.text}
            </div>
        `).join('');
        box.scrollTop = box.scrollHeight;
    });

    document.getElementById('send-btn').onclick = () => {
        const inp = document.getElementById('chat-input');
        if (inp.value.trim()) {
            push(ref(db, 'chat'), { sender: sessionUser, text: inp.value, time: serverTimestamp() });
            inp.value = '';
        }
    };

    // --- HUB FUNKCIJE ---
    function renderUserList() {
        const table = document.getElementById('user-table');
        const isAdmin = userDB[sessionUser]?.role === 'admin';
        const now = Date.now();
        let html = '<tr><th>Korisnik</th><th>Status</th><th>Akcija</th></tr>';
        
        Object.keys(userDB).forEach(u => {
            const isOnline = (now - (onlineData[u] || 0) < 25000);
            let btn = (isAdmin && u !== 'admin' && u !== sessionUser) ? `<button class="del-btn" onclick="window.removeU('${u}')">X</button>` : '-';
            html += `<tr><td>${u}</td><td style="color:${isOnline?'green':'gray'}">${isOnline?'‚óè':'‚óã'}</td><td>${btn}</td></tr>`;
        });
        table.innerHTML = html;
    }

    window.removeU = (name) => { if(confirm("Obri≈°i?")) remove(ref(db, 'users/'+name)); };

    document.getElementById('add-user-btn').onclick = () => {
        const u = document.getElementById('new-u').value.trim();
        const p = document.getElementById('new-p').value.trim();
        if(u && p) set(ref(db, 'users/'+u), { pass: p, role: 'user' });
    };

    window.logout = () => {
        if(sessionUser) remove(ref(db, 'online/' + sessionUser));
        localStorage.removeItem('os_session');
        location.reload();
    };

    // UI & SAT
    window.openApp = (id) => document.getElementById(id).style.display = 'flex';
    window.closeApp = (id) => document.getElementById(id).style.display = 'none';
    setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);

    // Draggable
    document.querySelectorAll('.window-header').forEach(h => {
        h.onmousedown = (e) => {
            let win = h.parentElement; win.style.zIndex = Math.floor(Date.now()/1000);
            let ox = e.clientX - win.offsetLeft, oy = e.clientY - win.offsetTop;
            document.onmousemove = (e) => { win.style.left = (e.clientX - ox) + 'px'; win.style.top = (e.clientY - oy) + 'px'; }
            document.onmouseup = () => document.onmousemove = null;
        }
    });
</script>
</body>
</html>
