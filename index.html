<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeminiOS v12.0 | NOU Management</title>
    <style>
        :root {
            --accent: #00d4ff;
            --glass: rgba(255, 255, 255, 0.1);
            --win-bg: #ffffff;
            --taskbar: rgba(0, 0, 0, 0.95);
            --os-font: 'Segoe UI', sans-serif;
            --danger: #e74c3c;
            --success: #27ae60;
        }

        * { box-sizing: border-box; font-family: var(--os-font); user-select: none; }
        body { 
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            background: #111 url('https://images.unsplash.com/photo-1451187580459-43490279c0fa?w=1920') no-repeat center center fixed; 
            background-size: cover; transition: 0.5s;
        }

        /* LOGIN */
        #login-screen {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(25px);
            display: flex; justify-content: center; align-items: center; z-index: 999999;
        }
        .login-box { background: var(--glass); padding: 40px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); text-align: center; color: white; width: 350px; }

        /* DESKTOP */
        #main-os { display: none; height: 100vh; width: 100vw; }
        #desktop { height: calc(100vh - 45px); padding: 25px; display: flex; flex-direction: column; flex-wrap: wrap; gap: 20px; align-content: flex-start; }
        
        .icon { width: 95px; text-align: center; color: white; cursor: pointer; transition: 0.2s; }
        .icon:hover { transform: translateY(-5px); }
        .icon span { font-size: 50px; display: block; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.6)); }
        .icon label { font-size: 12px; margin-top: 5px; display: block; text-shadow: 1px 1px 3px #000; font-weight: 500; }

        /* WINDOWS */
        .window { position: absolute; background: var(--win-bg); border-radius: 12px; box-shadow: 0 25px 70px rgba(0,0,0,0.7); display: none; flex-direction: column; overflow: hidden; border: 1px solid rgba(0,0,0,0.1); z-index: 10; }
        .window-header { background: #f1f1f1; padding: 12px 18px; display: flex; justify-content: space-between; align-items: center; cursor: move; border-bottom: 1px solid #ddd; }
        .win-title { font-size: 13px; font-weight: 700; color: #333; }
        .win-close { width: 14px; height: 14px; border-radius: 50%; background: #ff5f56; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); }

        /* CHAT UI */
        #chat-messages { flex-grow: 1; padding: 15px; overflow-y: auto; background: #fdfdfd; display: flex; flex-direction: column; gap: 10px; height: 300px; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 80%; font-size: 13px; position: relative; }
        .msg-other { background: #eee; align-self: flex-start; color: #333; }
        .msg-me { background: var(--accent); color: black; align-self: flex-end; }

        /* TASKBAR */
        #taskbar { position: fixed; bottom: 0; width: 100%; height: 45px; background: var(--taskbar); backdrop-filter: blur(20px); display: flex; align-items: center; padding: 0 15px; z-index: 1000000; }
        #start-btn { width: 34px; height: 34px; background: var(--accent); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 900; }
        #clock { margin-left: auto; color: white; font-size: 14px; }
        .online-count { font-size: 10px; background: var(--success); color: white; padding: 2px 6px; border-radius: 10px; margin-left: 10px; }
        
        /* TABLE & BUTTONS */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { text-align: left; padding: 10px; border-bottom: 1px solid #eee; }
        .del-btn { background: var(--danger); color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; }
        .del-btn:hover { opacity: 0.8; }
        input { border: 1px solid #ccc; outline: none; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <div style="font-size: 60px;">‚ôä</div>
        <h2>NOU OS</h2>
        <input type="text" id="user-in" placeholder="Username" style="width:100%; padding:12px; margin-bottom:10px; border-radius:8px;">
        <input type="password" id="pass-in" placeholder="Password" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px;">
        <button id="login-btn" style="width:100%; padding:12px; border-radius:8px; background:var(--accent); font-weight:bold; cursor:pointer;">ULAZ</button>
    </div>
</div>

<div id="main-os">
    <div id="desktop">
        <div class="icon" ondblclick="openApp('nou-app')"><span>üè¢</span><label>NOU Hub</label></div>
        <div class="icon" ondblclick="openApp('chat-win')"><span>üí¨</span><label>Tim Chat</label></div>
        <div class="icon" ondblclick="logout()"><span>üö™</span><label>Odjava</label></div>
    </div>

    <div id="chat-win" class="window" style="width: 400px; height: 500px; left: 500px; top: 100px;">
        <div class="window-header">
            <span class="win-title">üí¨ Chat U≈æivo</span>
            <div class="win-close" onclick="closeApp('chat-win')"></div>
        </div>
        <div id="chat-messages"></div>
        <div style="padding: 10px; border-top: 1px solid #eee; display: flex; gap: 10px;">
            <input type="text" id="chat-input" placeholder="Poruka..." style="flex-grow:1; padding:8px;">
            <button id="send-btn" style="padding:8px 15px; background:var(--accent); border:none; cursor:pointer;">></button>
        </div>
    </div>

    <div id="nou-app" class="window" style="width: 550px; height: 500px; left: 50px; top: 50px;">
        <div class="window-header">
            <span class="win-title">üè¢ NOU Management</span>
            <div class="win-close" onclick="closeApp('nou-app')"></div>
        </div>
        <div class="nou-body" style="padding:20px; overflow-y: auto; height: 440px;">
            <h3>Korisnici & Kontrola</h3>
            <div id="admin-tools" style="display:none; margin-bottom:20px; background:#f9f9f9; padding:15px; border-radius:8px; border: 1px solid #ddd;">
                 <label style="display:block; font-size:11px; margin-bottom:5px;">DODAJ NOVOG KORISNIKA:</label>
                 <input type="text" id="new-user-name" placeholder="User" style="width:100px; padding:5px;">
                 <input type="text" id="new-user-pass" placeholder="Pass" style="width:100px; padding:5px;">
                 <button id="add-user-btn" style="padding:5px 15px; background:var(--success); color:white; border:none; cursor:pointer; border-radius:4px;">+ Dodaj</button>
            </div>
            <table id="user-table"></table>
        </div>
    </div>

    <div id="taskbar">
        <div id="start-btn">‚ôä</div>
        <div style="margin-left:15px; color:white; font-size:12px;"><b id="taskbar-user"></b></div>
        <div class="online-count" id="live-count">...</div>
        <div id="clock">00:00:00</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, update, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAoPo3Dj5yoH4sQeTScWZce-jDDpkDPMt8",
        authDomain: "nou-management.firebaseapp.com",
        databaseURL: "https://nou-management-default-rtdb.firebaseio.com",
        projectId: "nou-management",
        storageBucket: "nou-management.firebasestorage.app",
        messagingSenderId: "1098791447574",
        appId: "1:1098791447574:web:6e4c666d302055658c9937",
        measurementId: "G-0MTKC7CZRJ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let userDB = {};
    let sessionUser = null;
    let onlineData = {};

    // LOGIN LOGIKA
    window.handleLogin = () => {
        const u = document.getElementById('user-in').value;
        const p = document.getElementById('pass-in').value;
        
        if (userDB[u] && userDB[u].pass === p) {
            sessionUser = u;
            localStorage.setItem('os_active_session', u);
            bootOS();
            updateStatus(true);
        } else {
            alert("Gre≈°ka: Korisnik ne postoji ili je lozinka pogre≈°na.");
        }
    };

    function bootOS() {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-os').style.display = 'block';
        document.getElementById('taskbar-user').innerText = sessionUser;
        if (userDB[sessionUser] && userDB[sessionUser].role === 'admin') {
            document.getElementById('admin-tools').style.display = 'block';
        }
    }

    // FIREBASE SINHRONIZACIJA
    onValue(ref(db, 'users'), (snapshot) => {
        userDB = snapshot.val() || { "admin": { pass: "admin123", role: "admin" } };
        const active = localStorage.getItem('os_active_session');
        if (active && userDB[active] && !sessionUser) {
            sessionUser = active;
            bootOS();
            updateStatus(true);
        }
        renderUserList();
    });

    onValue(ref(db, 'chat'), (snapshot) => {
        const messages = snapshot.val() ? Object.values(snapshot.val()) : [];
        const box = document.getElementById('chat-messages');
        box.innerHTML = messages.map(m => `
            <div class="msg ${m.sender === sessionUser ? 'msg-me' : 'msg-other'}">
                <small style="display:block; font-size:9px; opacity:0.7">${m.sender}</small>
                ${m.text}
            </div>
        `).join('');
        box.scrollTop = box.scrollHeight;
    });

    onValue(ref(db, 'online'), (snapshot) => {
        onlineData = snapshot.val() || {};
        const now = Date.now();
        let count = 0;
        for (let u in onlineData) {
            if (now - onlineData[u] < 20000) count++;
        }
        document.getElementById('live-count').innerText = `${count} Online`;
        renderUserList();
    });

    // SISTEMSKE FUNKCIJE
    function updateStatus(online) {
        if (!sessionUser) return;
        const sRef = ref(db, 'online/' + sessionUser);
        if (online) set(sRef, Date.now());
        else remove(sRef);
    }

    setInterval(() => updateStatus(true), 10000);

    window.sendChatMessage = () => {
        const input = document.getElementById('chat-input');
        if (!input.value.trim()) return;
        push(ref(db, 'chat'), {
            sender: sessionUser,
            text: input.value,
            timestamp: serverTimestamp()
        });
        input.value = '';
    };

    // RENDER TABELE SA OPCIJOM BRISANJA
    function renderUserList() {
        const table = document.getElementById('user-table');
        if(!table) return;
        const isAdmin = (userDB[sessionUser] && userDB[sessionUser].role === 'admin');
        const now = Date.now();

        let html = '<tr><th>Korisnik</th><th>Status</th><th>Akcija</th></tr>';
        
        Object.keys(userDB).forEach(u => {
            const isOnline = (now - (onlineData[u] || 0) < 20000);
            const statusHtml = isOnline ? '<b style="color:green">‚óè Online</b>' : '<span style="color:gray">Offline</span>';
            
            // Samo admin vidi dugme za brisanje i ne mo≈æe obrisati samog sebe
            let actionHtml = '-';
            if (isAdmin && u !== sessionUser && u !== 'admin') {
                actionHtml = `<button class="del-btn" onclick="deleteUser('${u}')">Ukloni</button>`;
            }

            html += `<tr>
                <td>${u} ${u === sessionUser ? '(Vi)' : ''}</td>
                <td>${statusHtml}</td>
                <td>${actionHtml}</td>
            </tr>`;
        });
        table.innerHTML = html;
    }

    // BRISANJE I DODAVANJE
    window.deleteUser = (username) => {
        if (confirm(`Da li ste sigurni da ≈æelite da obri≈°ete korisnika: ${username}?`)) {
            remove(ref(db, 'users/' + username));
        }
    };

    window.addUser = () => {
        const n = document.getElementById('new-user-name').value.trim();
        const p = document.getElementById('new-user-pass').value.trim();
        if (n && p) {
            update(ref(db, 'users/' + n), { pass: p, role: 'user' });
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-pass').value = '';
        } else {
            alert("Popunite oba polja!");
        }
    };

    window.logout = () => {
        updateStatus(false);
        localStorage.removeItem('os_active_session');
        location.reload();
    };

    // EVENT LISTENERS
    document.getElementById('login-btn').onclick = window.handleLogin;
    document.getElementById('send-btn').onclick = window.sendChatMessage;
    document.getElementById('add-user-btn').onclick = window.addUser;
    document.getElementById('chat-input').onkeypress = (e) => { if(e.key === 'Enter') window.sendChatMessage(); };

    window.openApp = (id) => { document.getElementById(id).style.display = 'flex'; };
    window.closeApp = (id) => { document.getElementById(id).style.display = 'none'; };

    setInterval(() => { 
        document.getElementById('clock').innerText = new Date().toLocaleTimeString(); 
    }, 1000);

    // Draggable
    document.querySelectorAll('.window-header').forEach(h => {
        h.onmousedown = (e) => {
            let win = h.parentElement;
            win.style.zIndex = Math.floor(Date.now()/1000);
            let ox = e.clientX - win.offsetLeft, oy = e.clientY - win.offsetTop;
            document.onmousemove = (e) => { win.style.left = (e.clientX - ox) + 'px'; win.style.top = (e.clientY - oy) + 'px'; }
            document.onmouseup = () => document.onmousemove = null;
        }
    });
</script>

</body>
</html>
